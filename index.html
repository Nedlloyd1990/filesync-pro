<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileSync Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        .action-btn {
            transition: transform 0.2s ease;
        }
        .action-btn:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto max-w-4xl bg-white shadow-lg rounded-lg overflow-hidden m-4">
        <div class="header bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 flex justify-between items-center">
            <span class="text-xl font-semibold">FileSync Pro</span>
            <span id="statusDot" class="w-3 h-3 rounded-full bg-green-400"></span>
        </div>
        <div class="p-6">
            <div id="status" class="text-center text-gray-500 text-sm mb-4">Connecting to server...</div>
            <div class="table-container">
                <table class="w-full table-auto border-collapse">
                    <thead class="bg-gray-200 sticky top-0">
                        <tr>
                            <th class="border-b border-gray-300">File Name</th>
                            <th class="border-b border-gray-300">Sent Time</th>
                            <th class="border-b border-gray-300">Viewed Time</th>
                            <th class="border-b border-gray-300">Downloaded Time</th>
                            <th class="border-b border-gray-300">File Size</th>
                            <th class="border-b border-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fileTable"></tbody>
                </table>
            </div>
            <div class="input-area mt-4 flex items-center gap-4">
                <button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 action-btn" onclick="document.getElementById('fileInput').click()">Send File</button>
                <input type="file" id="fileInput" class="hidden" onchange="sendFile()">
            </div>
        </div>
    </div>

    <script>
        const fileTable = document.getElementById('fileTable');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const statusDot = document.getElementById('statusDot');
        let socket;
        let lastSentMessageId = null;

        function generateMessageId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function initSocket() {
            socket = new WebSocket('wss://filesync-pro.onrender.com'); // Replace with your Render URL
            socket.onopen = () => {
                status.textContent = 'Connected to server';
                statusDot.classList.remove('bg-red-400');
                statusDot.classList.add('bg-green-400');
                console.log('WebSocket connected');
            };
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.fileName && data.fileContent && data.sentTime && data.messageId) {
                        // Skip displaying if this is the sender's own message
                        if (data.messageId === lastSentMessageId) {
                            lastSentMessageId = null;
                            return;
                        }
                        displayFileMessage(data, false);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            socket.onclose = (event) => {
                status.textContent = 'Disconnected from server';
                statusDot.classList.remove('bg-green-400');
                statusDot.classList.add('bg-red-400');
                console.log('WebSocket closed:', event);
            };
            socket.onerror = (error) => {
                status.textContent = 'Connection error';
                statusDot.classList.remove('bg-green-400');
                statusDot.classList.add('bg-red-400');
                console.error('WebSocket error:', error);
            };
        }

        function sendFile() {
            const file = fileInput.files[0];
            if (!file) return;
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('Server not connected. Please wait or refresh.');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Max size is 5MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const sentTime = new Date().toISOString();
                const messageId = generateMessageId();
                const fileData = {
                    fileName: file.name,
                    fileSize: file.size,
                    fileContent: e.target.result,
                    sentTime: sentTime,
                    messageId: messageId
                };
                lastSentMessageId = messageId;
                socket.send(JSON.stringify(fileData));
                displayFileMessage(fileData, true);
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        function displayFileMessage(data, isSent) {
            const row = document.createElement('tr');
            const sizeKB = (data.fileSize / 1024).toFixed(2);
            const viewedTime = new Date().toISOString();
            let downloadedTime = '-';
            row.innerHTML = `
                <td class="border-b border-gray-200">${data.fileName}</td>
                <td class="border-b border-gray-200">${new Date(data.sentTime).toLocaleString()}</td>
                <td class="border-b border-gray-200">${new Date(viewedTime).toLocaleString()}</td>
                <td class="border-b border-gray-200 downloaded-time">${downloadedTime}</td>
                <td class="border-b border-gray-200">${sizeKB} KB</td>
                <td class="border-b border-gray-200">
                    <a href="${data.fileContent}" download="${data.fileName}" class="text-blue-600 hover:underline download-link">Download</a>
                </td>
            `;
            fileTable.appendChild(row);

            // Track download
            const downloadLink = row.querySelector('.download-link');
            downloadLink.addEventListener('click', () => {
                const downloadCell = row.querySelector('.downloaded-time');
                downloadedTime = new Date().toISOString();
                downloadCell.textContent = new Date(downloadedTime).toLocaleString();
            });

            // Scroll to latest entry
            fileTable.parentElement.scrollTop = fileTable.parentElement.scrollHeight;
        }

        initSocket();
    </script>
</body>
</html>
